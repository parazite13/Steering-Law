<!DOCTYPE html>
<html>
<!-- En-tête de la page -->

<head>
	<title>Projet - Loi de Steering</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
</head>
<!-- Corps de la page -->

<body>

	<div class="jumbotron text-center py-2" id="experience">
		<div class="container-fluid">
			<div id="headExperience">
				<p>
					Quand vous êtes prêt, cliquez sur les deux cibles en alternant de gauche à droite, le plus vite et le plus précisément possible (essayez de minimiser les erreurs), en commençant par la cible bleue.<br>
					Le chronomètre démarre dès le premier clique…
				</p>
				<button class="btn btn-primary mb-2" id="startExperience" role="button" onclick="start()">Démarrer l'expérience</button>
			</div>
			<input class="form-control mx-auto" type="text" id="chronotime" value="" style="text-align: center; width: initial; visibility: hidden;"/>
			<canvas id="canvas" style="width: 100%; height:90vh; cursor: crosshair; background: #CED2D2;">
				Je suis un Canvas et je me porte mal.
			</canvas>
		</div>
	</div>

</body>
<script type="text/javascript">
	//canvas et contexte
	var canvas = $('#canvas');
	canvas[0].width = $("#canvas").width();
	canvas[0].height = $("#canvas").height();
	var ctx = canvas[0].getContext('2d');
	//variables de jeu
	var backPixels = [];	//pixels qui suit la souris
	var experienceCenter = new pixel(canvas[0].width/2, 400);
	var arc = new arc(experienceCenter, 300);

	canvas.mousemove(function(event){
		ctx.clearRect(0, 0, canvas[0].width, canvas[0].height); 
		var x = event.clientX;
		var y = event.clientY;

		var rect = canvas[0].getBoundingClientRect();
		x -= rect.left;
		y -= rect.top;

		var mouseX = x;
		var mouseY = y;

		arc.draw();
		setPixels(mouseX, mouseY);
		drawBackPixels();
	});

	function setPixels(x, y){

		var maxLength = 15;

		//dit si le pixel existe déjà dans le tableau ou non
		var isPresent = false;
		$(backPixels).each(function(index, value){
			if(value.x == x && value.y == y){
				isPresent = true;
				return false;//break
			}
		});
		//on rajoute le pixel s'il n'existe pas deja
		if(!isPresent){
			var newPix = new pixel(x, y);
			backPixels.push(newPix);
			//dit si le pixel est dans le chemin ou non (change sa couleur en fonction)
			var pixelCurrent = ctx.getImageData(x, y, 1, 1);
			var data = pixelCurrent.data;
			//s'il n'y rien sous notre souris (hors chemin)
			if(data[3] != 255){
				newPix.color = "#ff0000";
			}
		}
		//on supprime le dernier pixel
		if(backPixels.length > maxLength){
			backPixels.splice(0, 1);
		}
	}

	function distance(p1, p2){
		return Math.sqrt(
			(p2.x - p1.x)*(p2.x - p1.x) +
			(p2.y - p1.y)*(p2.y - p1.y));
	}

	function pixel(x, y){
		this.x = x;
		this.y = y;
		this.size = 2;
		this.color = "#ffffff"; //couleur du pixel quand il est dans le chemin
		this.draw = function(){
			ctx.fillStyle = this.color;
			ctx.beginPath();
			ctx.rect(this.x - this.size, this.y - this.size, this.size, this.size);
			ctx.fill();
		}
	}

	function arc(pixel, length){
		this.center = pixel;
		this.radius = length;
		this.color = "#0000ff";
		this.draw = function(){
			ctx.strokeStyle = this.color;
			ctx.beginPath();
			ctx.lineWidth = 80;
			ctx.arc(this.center.x, this.center.y, this.radius, 0, Math.PI, true);
			ctx.stroke();
		}
	}

	function drawBackPixels(){
		for(var i = 1; i < backPixels.length; i++){
			ctx.strokeStyle = backPixels[i-1].color;
			ctx.lineWidth = 2;
			ctx.beginPath();
			ctx.moveTo(backPixels[i-1].x,backPixels[i-1].y);
			ctx.lineTo(backPixels[i].x,backPixels[i].y);
			ctx.stroke();
		}
	}

	function start(){
		$('#chronotime').css('visibility', 'visible');
		var chrono = new timer();	
		chrono.run();
	}

	function timer(){
		this.dateStartChrono = new Date();
		this.end;
		this.diff;
		this.min;
		this.sec;
		this.msec;
		this.timerID;
		this.run = function(){
			this.end = new Date();
			this.diff = this.end - this.dateStartChrono;
			this.diff = new Date(this.diff);
			this.msec = this.diff.getMilliseconds();
			this.sec = this.diff.getSeconds();
			this.min = this.diff.getMinutes();
			if (this.min < 10){
				this.min = "0" + this.min;
			}
			if (this.sec < 10){
				this.sec = "0" + this.sec;
			}
			if(this.msec < 10){
				this.msec = "00" +this.msec;
			}
			else if(this.msec < 100){
				this.msec = "0" +this.msec;
			}
			$('#chronotime').val(this.min + " : " + this.sec + " : " + this.msec);
			this.timerID = setTimeout(this.run.bind(this), 10);
		}
		this.reset = function(){
			clearTimeout(this.timerID);
			$('#chronotime').val('00 : 00 : 00');
		}
		this.pause = function(){
			this.previousChrono = this.diff;
			clearTimeout(timerID);
		}
		this.resume = function(){
			this.dateStartChrono = new Date() - diff;
			this.dateStartChrono = new Date(this.dateStartChrono);
			doChrono();
		}
	}

</script>
</html>